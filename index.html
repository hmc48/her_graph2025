<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>救命救急センター充実度の比較</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: "Helvetica Neue", Arial, "Hiragino Kaku Gothic ProN", "Hiragino Sans", Meiryo, sans-serif; background-color: #f8f9fa; color: #333; margin: 0; padding: 20px; }
        .container { max-width: 1100px; margin: 0 auto; background: #fff; padding: 30px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1 { text-align: center; color: #1a73e8; margin-bottom: 30px; border-bottom: 2px solid #e8eaed; padding-bottom: 15px; }
        
        /* 選択ボックスエリア */
        .selection-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 30px; }
        .selector-group { background: #f1f3f4; padding: 15px; border-radius: 6px; border: 1px solid #dadce0; }
        .selector-group label { display: block; font-size: 0.85rem; font-weight: bold; margin-bottom: 5px; color: #5f6368; }
        select { width: 100%; padding: 8px; border-radius: 4px; border: 1px solid #ccc; margin-bottom: 10px; font-size: 0.9rem; }
        
        /* 結果表示エリア */
        #result-area { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 30px; }
        .info-card { padding: 12px; border-radius: 6px; border-left: 6px solid #ccc; background: #fff; box-shadow: 0 1px 3px rgba(0,0,0,0.1); font-size: 0.85rem; }
        .info-card h4 { margin: 0 0 8px 0; color: #1a73e8; font-size: 0.95rem; }
        .info-card div { margin-bottom: 4px; }
        .label { color: #70757a; width: 60px; display: inline-block; }

        /* グラフエリア */
        .chart-box { position: relative; height: 1300px; width: 100%; border: 1px solid #e8eaed; padding: 10px; border-radius: 8px; }
        #loading-msg { text-align: center; color: #666; font-weight: bold; padding: 50px; }
    </style>
</head>
<body>

<div class="container">
    <h1>救命救急センター充実度の比較（2024年1月～12月）</h1>
    <h3>※評価点と是正項目数によりランクが決定します。（S、A、B、Cの4種類）区分表に基づき詳細ランクを仮にA-1等と表記います。（一部項目省略）</h3>

    <div id="loading-msg">データを読み込み中...</div>

    <div class="selection-container" id="selection-ui" style="display:none;">
        </div>

    <div id="result-area"></div>

    <div class="chart-box" id="chart-ui" style="display:none;">
        <canvas id="comparisonChart"></canvas>
    </div>
</div>

<script>
    const GEOJSON_URL = './救命救急センター充実度令和6年.geojson';
    const MAX_HOSPITALS = 5;
    const COLORS = ['#4285F4', '#EA4335', '#FBBC05', '#34A853', '#9334E6'];
    
    // 都道府県の標準的な並び順
    const PREF_ORDER = [
        "北海道", "青森県", "岩手県", "宮城県", "秋田県", "山形県", "福島県",
        "茨城県", "栃木県", "群馬県", "埼玉県", "千葉県", "東京都", "神奈川県",
        "新潟県", "富山県", "石川県", "福井県", "山梨県", "長野県",
        "岐阜県", "静岡県", "愛知県", "三重県",
        "滋賀県", "京都府", "大阪府", "兵庫県", "奈良県", "和歌山県",
        "鳥取県", "島根県", "岡山県", "広島県", "山口県",
        "徳島県", "香川県", "愛媛県", "高知県",
        "福岡県", "佐賀県", "長崎県", "熊本県", "大分県", "宮崎県", "鹿児島県", "沖縄県"
    ];

    let masterData = [];
    let prefList = [];
    let itemKeys = [];
    let myChart = null;

    async function init() {
        try {
            const response = await fetch(GEOJSON_URL);
            if (!response.ok) throw new Error('Network error');
            const data = await response.json();
            
            masterData = data.features.map(f => f.properties);
            
            // 都道府県リストの作成とソート（PREF_ORDERに基づく）
            const rawPrefs = [...new Set(masterData.map(d => d.都道府県))];
            prefList = rawPrefs.sort((a, b) => {
                let indexA = PREF_ORDER.indexOf(a);
                let indexB = PREF_ORDER.indexOf(b);
                // リストにない場合（表記揺れ等）は最後に
                if (indexA === -1) indexA = 99;
                if (indexB === -1) indexB = 99;
                return indexA - indexB;
            });
            
            // 評価項目 (1)〜(42) を抽出
            itemKeys = Object.keys(masterData[0]).filter(k => k.match(/^\(\d/)).sort((a, b) => {
                const aNum = parseFloat(a.match(/\d+(\.\d+)?/)[0]);
                const bNum = parseFloat(b.match(/\d+(\.\d+)?/)[0]);
                return aNum - bNum;
            });

            document.getElementById('loading-msg').style.display = 'none';
            document.getElementById('selection-ui').style.display = 'grid';
            document.getElementById('chart-ui').style.display = 'block';

            createSelectors();
        } catch (err) {
            document.getElementById('loading-msg').innerText = 'エラー：データの読み込みに失敗しました。';
            console.error(err);
        }
    }

    function createSelectors() {
        const container = document.getElementById('selection-ui');
        for (let i = 0; i < MAX_HOSPITALS; i++) {
            const group = document.createElement('div');
            group.className = 'selector-group';
            group.innerHTML = `
                <label>病院選択 ${i + 1}</label>
                <select id="pref-${i}" onchange="onPrefChange(${i})">
                    <option value="">都道府県を選択</option>
                    ${prefList.map(p => `<option value="${p}">${p}</option>`).join('')}
                </select>
                <select id="hosp-${i}" onchange="updateView()" disabled>
                    <option value="">病院を選択</option>
                </select>
            `;
            container.appendChild(group);
        }
    }

    function onPrefChange(index) {
        const pref = document.getElementById(`pref-${index}`).value;
        const hospSelect = document.getElementById(`hosp-${index}`);
        
        if (!pref) {
            hospSelect.innerHTML = '<option value="">病院を選択</option>';
            hospSelect.disabled = true;
        } else {
            const filtered = masterData.filter(d => d.都道府県 === pref).sort((a, b) => a.病院名.localeCompare(b.病院名, 'ja'));
            hospSelect.innerHTML = '<option value="">病院を選択</option>' + 
                filtered.map(d => `<option value="${d.病院名}">${d.病院名}</option>`).join('');
            hospSelect.disabled = false;
        }
        updateView();
    }

    function updateView() {
        const selectedHospitals = [];
        const resultArea = document.getElementById('result-area');
        resultArea.innerHTML = '';

        for (let i = 0; i < MAX_HOSPITALS; i++) {
            const pref = document.getElementById(`pref-${i}`).value;
            const hospName = document.getElementById(`hosp-${i}`).value;

            if (pref && hospName) {
                const data = masterData.find(d => d.都道府県 === pref && d.病院名 === hospName);
                if (data) {
                    selectedHospitals.push({ data, color: COLORS[i] });
                    resultArea.innerHTML += `
                        <div class="info-card" style="border-left-color: ${COLORS[i]}">
                            <h4>${data.病院名}</h4>
                            <div><span class="label">種類:</span> ${data.種類 || '-'}</div>
                            <div><span class="label">評価点:</span> <b>${data.評価点 || '0'}</b> 点</div>
                            <div><span class="label">詳細ランク:</span> <b>${data.詳細ランク || '-'}</b></div>
                        </div>
                    `;
                }
            }
        }
        drawChart(selectedHospitals);
    }

    function drawChart(hospitals) {
        const ctx = document.getElementById('comparisonChart').getContext('2d');
        if (myChart) myChart.destroy();
        if (hospitals.length === 0) return;

        const datasets = hospitals.map(h => ({
            label: h.data.病院名,
            data: itemKeys.map(k => h.data[k] || 0),
            backgroundColor: h.color,
            borderWidth: 0
        }));

        myChart = new Chart(ctx, {
            type: 'bar',
            data: { labels: itemKeys, datasets: datasets },
            options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        beginAtZero: true,
                        max: 4,
                        ticks: {
                            stepSize: 1,
                            precision: 0
                       },
                       title: { display: true, text: 'スコア' }
                    },
                    y: { ticks: { font: { size: 10 }, autoSkip: false } }
                },
                plugins: {
                    legend: { position: 'bottom' },
                    tooltip: { mode: 'index', intersect: false }
                }
            }
        });
    }

    window.onload = init;
</script>

</body>
</html>